openapi: 3.0.0
info:
  title: Lab COVID-19 result API
  description: "Dokumentācija laboratoriju COVID-19 testa datu API iesūtīšanai. Datu iesūtīšanas mērķis ir saņemt nepieciešamo informāciju par COVID-19 testiem, ko tālāk izmantotu vairākiem mērķiem: DZS (Digitālā Zaļā Sertifikāta) izveidei, VMNVD (LR Veselības ministrijas Nacionālā veselības dienesta) vajadzībām, SPKC (Slimību profilakses un kontroles centra) vajadzībām un VI (Veselības Inspekcijas) vajadzībām. Izveidotās datu struktūras ir specifiskas COVID-19 vajadzībām, kā arī to izveidē ir mēģināts pēc iespējas saglabāt un atkārtoti izmantot EVK klasifikatorus un FHIR datu struktūru nosaukumus atbilstoši: https://www.hl7.org/fhir/diagnosticreport.html    COVID-19 Diagnostikas pārskata pievienošana notiek asinhronā režīmā (primārā atgrieztā atbilde vienmēr ir HTTP 202 (Accepted)). Atbildē tiek atgriezts konkrētā izsaukuma statusa pārbaudes URL, kuru izmantojot organizācija var pieprasīt iesūtītā pierasījuma verifikācijas statusu. Verifikācijas statusa pārbaude jāveic, izmantojot Ekponenciālo atkāpšanās pieeju: https://en.wikipedia.org/wiki/Exponential_backoff "
  contact:
    name: SIA ZZ Dats, SIA KleinTech Services
    email: zzdats@zzdats.lv
  version: '1.0'
servers:
  - url: 'https://dgc-dev.zzdats.lv/elab-result'
tags:
- name: "LabRecordsBatch"
  description: "Rezultātu masveida datu iesūtīšana"
- name: "LabRecords"
  description: "Datu apstrāde pa vienam iesūtītajam ierakstam"
paths:
  /api/LabRecordsBatch:
    post:
      summary: "Ielādēt rezultātu kopu"
      tags:
        - LabRecordsBatch
      operationId: LabRecordsBatch_SaveLabRecordsBatch
      requestBody:
        x-name: request
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LabRecordsBatch'
        required: true
        x-position: 1
      responses:
        '200':
          description: "Rezultāts pieņemts apstrādei"
        '400':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '404':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '422':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '500':
          description: "Izpildes kļūda servera pusē"
      security:
        - Bearer: []
  /api/LabRecordsBatch/{Batchid}:
    get:
      tags:
        - LabRecordsBatch
      summary: "Pieprasīt ielādes statusu konkrētai datu pakai"
      operationId: "getLabRecordsBatchStatus"
      parameters:
      - name: BearerToken
        in: header
        description: "Bearer token izsniegts sesijas sākumā"
        required: true
        schema:
          type: string
      - name: "Batchid"
        in: "path"
        description: "ID par kur pieprasīt ielādes statusu"
        required: true
        schema:
          type: "string"
      responses:
        '200':
          description: "Rezultāts pieņemts apstrādei"
        '400':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '404':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '422':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '500':
          description: "Izpildes kļūda servera pusē"
      security:
        - Bearer: []
    delete:
      tags:
        - LabRecordsBatch
      operationId: LabRecordsBatch_DeleteLabRecordsBatch
      summary: "Atsaukt konkrētas datu pakas ielādi"
      parameters:
      - name: "Batchid"
        in: path
        description: "Batch identifikators, ko pieprasīts izdzēst/anulēt"
        required: true
        schema: 
          type: string
      - name: BearerToken
        in: header
        description: "Bearer token izsniegts sesijas sākumā"
        required: true
        schema:
          type: string
      responses:
        '200':
          description: "Rezultāts pieņemts apstrādei"
        '400':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '404':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '422':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '500':
          description: "Izpildes kļūda servera pusē"
    put:
      tags:
        - LabRecordsBatch
      operationId: LabRecordsBatch_UpdateLabRecordsBatch
      summary: "Atjaunināt iesūtītu datu pakotni"
      parameters:
      - name: BearerToken
        in: header
        description: "Bearer token izsniegts sesijas sākumā"
        required: true
        schema:
          type: string
      - name: "Batchid"
        in: path
        description: "Batch identifikators, ko pieprasīts izdzēst/anulēt"
        required: true
        schema: 
          type: string
      responses:
        '200':
          description: "Iesūtītie dati pieņemti apstrādei"
  /api/LabRecords:
    post:
      tags:
        - LabRecords
      operationId: LabRecords_Post
      summary: "Ielādēt viena iesūtītā rezultāta datus"
      parameters:
      - name: BearerToken
        in: header
        description: "Bearer token izsniegts sesijas sākumā"
        required: true
        schema:
          type: string
      requestBody:
        x-name: request
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LabRecords'
      responses:
        "200":
          description: "TBD: LabRecordPostId"
  /api/LabRecords/{RecordId}:
    get:
      tags:
        - LabRecords
      operationId: LabRecords_Get
      summary: "Izgūt viena iesūtītā rezultāta datus"
      parameters:
      - name: BearerToken
        in: header
        description: "Bearer token izsniegts sesijas sākumā"
        required: true
        schema:
          type: string
      - name: "RecordId"
        in: path
        description: "Iesūtītā rezultāta identifikators, ko pieprasa"
        required: true
        schema: 
          type: string
      responses:
        "200":
          $ref: "#/components/schemas/LabRecords"
    put:
      tags:
        - LabRecords
      operationId: LabRecords_Put
      summary: "Labot viena iesūtītā rezultāta datus"
      parameters:
      - name: BearerToken
        in: header
        description: "Bearer token izsniegts sesijas sākumā"
        required: true
        schema:
          type: string
      - name: "RecordId"
        in: path
        description: "Iesūtītā rezultāta identifikators, ko pieprasa"
        required: true
        schema: 
          type: string
      responses:
        "200":
          description: "Iesūtītie dati pieņemti apstrādei"
    delete:
      tags:
        - LabRecords
      operationId: LabRecords_Delete
      summary: "Dzēst viena iesūtītā rezultāta datus"
      parameters:
      - name: BearerToken
        in: header
        description: "Bearer token izsniegts sesijas sākumā"
        required: true
        schema:
          type: string
      - name: "RecordId"
        in: path
        description: "Iesūtītā rezultāta identifikators, ko pieprasa"
        required: true
        schema: 
          type: string
      responses:
        "200":
          description: "Veikta ieraksta dzēšana"
  /api/LabRecordsStatus/{PostId}:
    get:
      tags:
        - LabRecords
      summary: "Pieprasīt ielādes statusu konkrētai datu pakai"
      operationId: "getLabRecordsStatus"
      parameters:
      - name: BearerToken
        in: header
        description: "Bearer token izsniegts sesijas sākumā"
        required: true
        schema:
          type: string
      - name: "PostId"
        in: "path"
        description: "ID par kur pieprasīt ielādes statusu (atgriezts no konkrēta ieraksta labošanas vai ielādes)"
        required: true
        schema:
          type: "string"
      responses:
        '200':
          description: "Rezultāts pieņemts apstrādei"
        '400':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '404':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '422':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '500':
          description: "Izpildes kļūda servera pusē"
      security:
        - Bearer: []
  /api/DZSdata/{PersonId}:
    get: 
      tags:
        - DZSdata
      summary: "Izgūt DZS par konkrētu personu"
      operationId: "getDZSforPerson"
      parameters:
      - name: BearerToken
        in: header
        description: "Bearer token izsniegts sesijas sākumā"
        required: true
        schema:
          type: string
      - name: "PersonId"
        in: "path"
        description: "ID par kur pieprasīt ielādes statusu (atgriezts no konkrēta ieraksta labošanas vai ielādes)"
        required: true
        schema:
          type: "string"
      responses:
        '200':
          description: "Rezultāts pieņemts apstrādei"
        '400':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '404':
          description: "Persona nav atrasta"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
  /api/DZSdata/{ResultId}:
    get: 
      tags:
        - DZSdata
      summary: "Izgūt DZS par konkrētu iesūtītu izmeklējumu"
      operationId: "getDZSforResult"
      parameters:
      - name: BearerToken
        in: header
        description: "Bearer token izsniegts sesijas sākumā"
        required: true
        schema:
          type: string
      - name: "ResultId"
        in: "path"
        description: "ID par kur pieprasīt ielādes statusu (atgriezts no konkrēta ieraksta labošanas vai ielādes)"
        required: true
        schema:
          type: "string"
      responses:
        '200':
          description: "Rezultāts pieņemts apstrādei"
        '400':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '404':
          description: "Rezultāts nav atrasts"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails' 
components:
  schemas:
    ProblemDetails:
      type: object
      additionalProperties:
        nullable: true
      properties:
        type:
          type: string
          nullable: true
        title:
          type: string
          nullable: true
        status:
          type: integer
          format: int32
          nullable: true
        detail:
          type: string
          nullable: true
        instance:
          type: string
          nullable: true
    LabRecordsBatch:
      type: object
      additionalProperties: false
      required:
        - identifier
        - requestDate
        - resultList
      properties:
        Batchid:
          type: string
          format: guid
          minLength: 1
          description: "Pieprasījuma unikāls identifikators GUID formātā. Sūtot sākotnējo pieprasījumu lauks tiek atstāts tukšs (identifikators tiks saņemts Response ietvarā)"
          example: "42a6d49b-bc50-4e12-b61a-3e3ad9fa7edd"
        requestDate:
          type: string
          format: date-time
          minLength: 1
          description: "Pieprasījuma datums un laiks. Tiek sagaidīts laiks UTC zonā"
        resultList:
          type: array
          items:
            $ref: '#/components/schemas/LabRecords'
    LabRecords:
      type: object
      additionalProperties: false
      required:
        - subject
        - countryCode
        - personCode
        - firstName
        - lastName
        - birthDate
        - sex
        - answerReceiveType
        - examinations
      description: "Saraksts ar iesūtīto testu rezultātu datiem par personu"
      properties:
        subject:
          type: string
          minLength: 1
          description: "Personas unikāls identifikators Laboratorijas sistēmā"
        countryCode:
          $ref: '#/components/schemas/CountryCode'
        personCode:
          type: string
          maxLength: 100
          minLength: 0
          description: "Pacienta identifikācijas kods. Latvijas gadījumā (clountryCode = LV) tas būs personas kods. Ārvalstu gadījumā tas būs pacienta identifikācijas numurs, kas pacientam piešķirts attiecīgajā valstī"
        firstName:
          type: string
          maxLength: 300
          minLength: 0
          description: "Pacienta vārds (vārdi)"
        lastName:
          type: string
          maxLength: 300
          minLength: 0
          description: "Pacienta uzvārds (uzvārdi)"
        birthDate:
          type: string
          format: date
          minLength: 1
          description: "Pacienta dzimšanas datums (tikai YYYY-MM-DD formātā)"
        gender:
          $ref: '#/components/schemas/Gender'
        addressResidence:
          type: array
          nullable: true
          description: "Pacienta norādītās uzturēšanās adreses (viena vai vairākas)"
          items:
            $ref: '#/components/schemas/Address'
        telco:
          $ref: '#/components/schemas/ContactPoint'
        contactPersons:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/ContactPerson'
        answerReceiveType:
          $ref: '#/components/schemas/AnswerReceiveType'
        pin:
          type: string
          nullable: true
          description: "Pacientam piešķirtais PIN kods, ar kuru tas varēs iegūt DZS pašapkalpošanās portālā. Vismaz 6 simboli, ietver burtus un ciparus. Case Sensitive. "
        examinations:
          type: array
          items:
            $ref: '#/components/schemas/Examination'
    CountryCode:
      type: integer
      description: "Valsts kods ISO 3166-1 alpha 3 formata https://en.wikipedia.org/wiki/ISO_3166-1_alpha-3"
    Gender:
      type: string
      description: "Personas dzimums. Klasifikators VVIS 2.111"
    Address:
      type: object
      additionalProperties: false
      required:
        - addressId
        - addressCountry
        - addressType
      properties:
        addressId:
          type: string
          minLength: 1
        addressCountry:
          $ref: '#/components/schemas/CountryCode'
        addressType:
          $ref: '#/components/schemas/AddressType'
        addressRegisterId:
          $ref: '#/components/schemas/AddressRegisterId'
        addressText:
          type: string
          maxLength: 500
          minLength: 0
          nullable: true
        addressATVK:
          nullable: true
          oneOf:
            - $ref: '#/components/schemas/AddressATVK'
    AddressType:
      type: string
      description: "Adreses tips"
      enum: [VZD_ATVK_adrese, briva_teksta_adrese]
    AddressRegisterId:
      type: integer
      description: ''
    AddressATVK:
      type: object
      additionalProperties: false
      properties:
        typeOfTerritory:
          $ref: '#/components/schemas/TeritoryType'
        atvk1:
          $ref: '#/components/schemas/Atkv1'
        atvk2:
          $ref: '#/components/schemas/Atkv2'
        atvk3:
          $ref: '#/components/schemas/Atkv3'
        village:
          $ref: '#/components/schemas/Village'
        street:
          $ref: '#/components/schemas/Street'
        houseNr:
          type: string
          maxLength: 5
          minLength: 0
          nullable: true
        houseName:
          type: string
          maxLength: 100
          minLength: 0
          nullable: true
        building:
          type: string
          maxLength: 10
          minLength: 0
          nullable: true
        flat:
          type: string
          maxLength: 100
          minLength: 0
          nullable: true
    TeritoryType:
      type: integer
      description: ''
    Atkv1:
      type: integer
      description: ''
    Atkv2:
      type: integer
      description: ''
    Atkv3:
      type: integer
      description: ''
    Village:
      type: integer
      description: ''
    Street:
      type: integer
      description: ''
    Phone:
      type: object
      additionalProperties: false
      properties:
        areaCode:
          $ref: '#/components/schemas/AreaCode'
        phoneNumber:
          type: integer
          format: int32
          pattern: '^[0-9]{1,15}$'
    AreaCode:
      type: integer
      description: ''
    ContactPoint:
      type: "object"
      description: ""
      properties:
        id: 
          type: "string"
          description: "Kontaktinformācijas identifikators (unikāls ID laboratorijas ietvaros, ko piešķir savā p usē laboratorija) "
        system: 
          type: "string"
          enum: [phone, fax, email, pager, other]
          description: "Norādītā kontakta veids (tipiski: phone vai email)"
        value:
          type: "string"
          description: "Kontaktinformācijas saturs (atkarībā no veida  telefona nr – IETVEROT VALSTS KODU UN  “00” priekšā vai e-pasts – e-pastam tiks veikta validācija pret e-pasta adreses formātu)"
        use:
          type: "string"
          enum: [home, work, temp, old, mobile]
          description: "Norādītā kontakta saziņas mehānisms: tipiski home vai mobile, bet drīkst izmantot arī citas vērtības"
        rank:
          type: "integer"
          format: "int32"
          minimum: 1
          description: "Komunikācijas secība nodotajam kontakta paveidam (minimālā vērtība 1, bet var būt augstāka)"
    ContactPerson:
      type: object
      description: "Pacienta norādīto kontaktpersonu saraksts "
      additionalProperties: false
      required:
        - contactPersonType
        - contactInfoType
        - contactInfo
      properties:
        relationship:
          $ref: '#/components/schemas/Relationship'
        telco:
          $ref: '#/components/schemas/ContactPoint'
    Relationship:
      type: integer
      description: "Pacienta norādītās kontaktpersonas veids (māsa, brālis u.tml.). Dati no VVIS 2.68 klasfikatora."
    AnswerReceiveType:
      type: string
      description: "Atbildes saņemšanas veids. (a) ar drošiem  autorizācijas līdzekļiem (latvija.lv); (b) ar PIN + dzimšanas datumu, izmantojot URL (Laboratorijai pacients jābrīdina, ka viņa datiem nebūs pilni auditācijas pieraksti - netiks rādīts, kas ir apskatījis datus, bet tikai fakts, ka tie ir apskatīti, izmantojot PIN); (c) gan droši autorizācijas līdzekļi (latvija.lv VPM), gan PIN+dzimšanas datums autorizācijas līdzekļiem "
      enum: [secure_only, pin_only, secure_and_pin, unspecified]
    Examination:
      type: object
      additionalProperties: false
      required:
        - encounterId
        - testDate
        - testSubject
        - testType
        - sampleId
        - sampleType
        - responsibleForTestResult
        - responsiblePersonPhone
        - ordererOfTest
        - operator
        - resultList
      properties:
        encounterId:
          type: string
          minLength: 1
          description: "Vizītes unikālais identifikators Laboratorijas sistēmā"
        testDate:
          type: string
          format: date-time
          minLength: 1
          description: "Izmeklējuma veikšanas datums un laiks. Tiek sagaidīts laiks UTC zonā"
        testSubject:
          type: string
          minLength: 1
          description: "Izmeklējuma mērķis. Pašreiz konstante COVID-19 "
        testType:
          type: string
          minLength: 1
          description: "Izmeklējuma veids NAAT/RAT (provizoriski no https://loinc.org/sars-cov-2-and-covid-19/ )"
        testName:
          $ref: '#/components/schemas/TestName'
        testManufacturer:
          $ref: '#/components/schemas/TestManufacturer'
        sampleId:
          type: string
          minLength: 1
          description: "Materiāla unikālais identifikators Laboratoriju sistēmā"
        sampleType:
          $ref: '#/components/schemas/SampleType'
        responsibleForTestResult:
          type: string
          minLength: 1
          description: "Ārstniecības persona, kura atbild par testa rezultātu, Veselības inspecijas piešķirtais identifikators. Iesūta identifikatoru no 2.37 un pēc id18 koda pārbauda pret 2.1 id4 "
        responsiblePersonPhone:
          type: string
          minLength: 1
          description: "Ārstniecības personas, kura atbild par testa rezultātu telefona numurs, ietverot valsts kodu un 00 prefiksu"
        ordererOfTest:
          $ref: '#/components/schemas/OrdererOfTest'
        testGroup:
          type: string
          nullable: true
          description: "Testējamās grupas nosaukums "
        testOrganizer:
          type: string
          nullable: true
          description: "Testēšanas organizatora kontaktinformācija brīvā formā (vārds, uzvārds, telefons). SPKC izmantošanai "
        referralType:
          $ref: '#/components/schemas/ReferralType'
        referral:
          type: string
          nullable: true
          description: "Nosūtījuma numurs (aizpildāms par papīra nosūtījumu un elektronisko nosūtījumu)"
        referralMedicalPerson:
          $ref: '#/components/schemas/ReferralMedicalPerson'
        payerForTest:
          $ref: '#/components/schemas/PayerForTest'
        cause:
          type: string
          description: "Indentificēts COVID-19 infekcijas celms. Provizoriski atbilstošs LOINC pre-release klasifikatoram: 96741-4"
        operator:
          type: string
          maxLength: 11
          minLength: 11
          description: "Datu ievadītāja personas kods"
        resultList:
          type: array
          items:
            $ref: '#/components/schemas/Result'
    TestName:
      type: string
      description: "Testa nosaukums. Obligāts, ja testType = RAT"
    TestManufacturer:
      type: string
      description: "Testa ražotājs. Obligāts, ja testType = RAT"
    SampleType:
      type: string
      description: "Parauga veids (klasifikators, provizoriski balstīts uz https://www.hl7.org/fhir/v2/0487/index.html"
    OrdererOfTest:
      type: string
      description: "Izmeklējuma pasūtītājs no klasifikatora (paredzamās vērtības: Pacients, ārstniecības persona, SPKC, Veselības Inspekcija (VI), cits). Ja pasūtītājs ir SPKC vai VI, tad obligāti ir papildus lauki"
    ReferralType:
      type: integer
      description: "Nosūtījuma veids: E-nosūtījums, Papīra formas nosūtījums, Nav nosūtījuma, Nav informācijas"
    ReferralMedicalPerson:
      type: string
      description: "Ārstniecības personas reģistrācijas numurs (Nosūtītājs). Aizpildāms no VVIS 2.1 klasifikatora"
    PayerForTest:
      type: integer
      description: "Testa apmaksātājs"
    Result:
      type: object
      additionalProperties: false
      required:
        - resultId
        - versionId
        - resultStatus
        - resultDate
        - resultType
        - resultContent
      properties:
        resultId:
          type: string
          description: "Rezultāta unikāls identifikators. Ja rezultāts ir par jau iepriekš iesūtītu izmeklējumu, tad šeit ir jāiesūta iepriekš saņemtais identifikators no response servisa par konkrēto rezultātu. Ja šis ir jauns rezultāts, lauks jāatstāj tukšs"
        versionId:
          type: integer
          format: int32
          description: "Iesūtītā rezultāta versija (augoša vērtība pret iepriekšējo rezultātu) "
        resultStatus:
          $ref: '#/components/schemas/ResultStatus'
        resultDate:
          type: string
          format: date-time
          minLength: 1
          description: "Datums un laiks, kurā ārstniecības persona apstiprināja testa rezultātu. Tiek sagaidīts laiks UTC laika zonā "
        resultType:
          $ref: '#/components/schemas/ResultType'
        resultContent:
          $ref: '#/components/schemas/ResultContent'
        resultMetric:
          type: string
          nullable: true
          description: "Rezultāta mērvienība, ja kvantitatīvi dati"
        resultReferenceValue:
          type: string
          description: "Rezultāta references intervāls"
    ResultStatus:
      type: string
      description: "Rezultāta statuss. Iespējams tiks Balstīts uz FHIR vērtībām (skatīt arī izmantotos kanoniskos statusus katram apakšstatusam)https://www.hl7.org/fhir/valueset-diagnostic-report-status.html"
      enum: [registered, partial, perliminary, final, amended, corrected, appended, cancelled, entered-in-error, unkown]
    ResultType:
      type: string
      description: "Rezultāta veids (kvantitatīvs, kvalitatīvs). Rezultāta veids nosaka kāds ir atbilstošā rezultāta veids"
    ResultContent:
      type: string
      description: "Rezultāta saturs (ja kvantitatīvs, tad cipars, ja kvalitatīvs, tad pret klasifikatoru (pozitīvs /negatīvs /robežvērtība /apšaubāms) "
  securitySchemes:
    Bearer:
      type: apiKey
      description: 'Token Authorization header using Bearer scheme. Example: "Authorization: Bearer {token}"'
      name: Authorization
      in: header
security:
  - Bearer: []
